\section{Реализация}
Ранее упоминалось, что для корректной работы репозитория необходимо
поддерживать актуальное состояние индекса. 
По сути, обеспечение нужного состояния заключается в проверке текущего,
уже сформированного индекса и механизма его обновления, то есть
утилит \textit{ds-repo}, \textit{ds-patch} и \textit{ds-provides}.\\

Таким образом, можно сформилировать цели настоящей работы:
\begin{itemize}
\item{Создание утилиты для проверки готового индекса.}
\item{Тестирование утилит для обновления индекса.}
\end{itemize}


В качестве языка программирования для реализации решения был выбран \textit{Python}.\\
Основная функциональность решения представлена в модуле \textit{ds\_test.py}, который
будет подробно описан далее.

\subsection{Индекс репозитория Deepsolver}
Выше упоминалось , что вспомогательная информация о наборе пакетов репозитория
хранится в индексе. У \textit{Deepsolver} в каталоге \textit{base.*}, предназначенного для хранения индекса,
содержатся следующие файлы:\\
\begin{itemize}
\item{\textit{info} --- информационный файл с параметрами индекса;} 
\item{\textit{rpms.complete.data} --- вспомогательный файл, не предназначенный
для загрузки пользователями, с информацией для повторной фильтрации
provides;}
\item{\textit{rpms.data} --- основной список пакетов с информацией о зависимостях между ними;}
\item{\textit{rpms.descr.data} --- список пакетов с расширенными описаниями;}
\item{\textit{rpms.filelist.data} --- списки файлов для каждого бинарного пакета;}
\item{\textit{srpms.data} --- основная информация о пакетах с исходными текстами;}
\item{\textit{srpms.descr.data} --- список пакетов с исходными текстами, содержащий
расширенную информацию.}
\end{itemize} 
Каталог  \textit{base.*} существует для каждой архитектуры, \textit{i586}, \textit{x86\_64}, пакеты,
независящие от архитектуры, содержаться в каталоге \textit{noarch}.\\

\subsection{Модуль ds\_test.py}
\textit{ds\_test.py} предоставляет основную функциональность утилиты  как для тестирования
готового индекса, так и для проверки после обновления. Ниже представлена диаграмма~классов данного модуля.\\
%%FIXME:Диаграмма классов
\\
\begin{figure}[!ht]
\begin{center}
\includegraphics[scale=0.6, clip]{../resources/uml/ds_test_class_diagram.jpg}
\caption{Диаграмма классов модуля ds\_test.py}
\label{gr:dstestclassdiag}
\end{center}
\end{figure}

\textit{Package} - это класс, объекты которого представляют отдельные пакеты и, как видно из диаграммы,
содержат информацию а пакете, если сопоставлять: полю \textit{name} соответствует строка, заключенная
в квадратные скобки, полю \textit{short\_name} - строка, идущая ниже, а \textit{provides}, \textit{requires}
и \textit{conflicts} - это массивы строк, соответствующие одноименным множествам пакета. \\

Класс \textit{IndexParser} отвечает за разбор файлов индекса, в качестве параметра конструктора
ожидается файл, который необходимо обработать. Метод \textit{\_append\_index\_filename} получает на вход
имя директории с целевым файлом и образует из него и имени файла для парсинга
путь.\\
Основным методом класса \textit{IndexParser} является \textit{get\_packages\_from\_index\_file}.
В качестве входных данных используется сформированный ранее путь к файлу с данными
для парсинга. Этот метод возвращает генератор массива объектов класса \textit{Package.}\\

Тот факт, что метод \textit{get\_packages\_from\_index\_file} возвращает генератор позволяет
его использовать в том числе и для парсинга сразу нескольких файлов. Это происходит
в методе \textit{get\_packages\_from\_index\_files}, который на вход получает массивов файлов, 
затем для каждого файлы вызывает предыдущий метод. Этот метод так же возвращает
генератор массива объектов класса \textit{Package}.\\

Класс \textit{IndexTestResult} предназначен для удобной работы с результатами тестирования. 
У этого класса есть три метода отвечающие за накопление результатов тестирования:
\textit{add\_unmatched\_provide}, \textit{add\_unmatched\_require} и \textit{add\_unmatched\_conflict}, каждый из которых
в качестве первого аргумента получает объект класса \textit{Package} - текущий пакет, а в качестве второго
- строку, соответствующую повреждению(из множества \textit{provides}, \textit{requires} или \textit{conflicts}).
Для управления выводом переопределен метод \textit{\_\_str\_\_}. Так же у класса существует метод \textit{diff},
принимающий в качестве аргумента объект класса \textit{IndexTestResult}. Назначение метода 
заключается в том, чтобы при существовании двух результатов тестирования (объектов
класса \emph{IndexTestResult}) второй содержал только новые повреждения, то есть отсутствующие
в первом.\\

В классе \textit{IndexTester} определены методы, непосредственно отвечающие за тестирование
индекса. При создании объекта данного класса в конструкторе передается файл с директориями,
в которых может находится \textit{provide}, не считаясь избыточным. 
Алгоритм тестирования реализован в методе \textit{test\_index}. Этот метод на вход
получает массив объектов класса \textit{Package}. Алгоритм выглядит следующим образом:
\begin{enumerate}
\item{Инициализация списка имен пакетов - \textit{names\_set}, списка \textit{provides} и 
списка \textit{requires\_conflicts}}
\item{Совершается проход в цикле по всем пакетам. На каждом шаге 
к уже сформированным спискам \textit{provides}, \textit{requires\_conflicts} и \textit{names\_set} 
добавляются данные пакета. В результате получаем набор списков всех \textit{provides}, 
\textit{requires\_conflict} и имен для набора пакетов}
\item{Создается объект класса \textit{IndexTestResult}}
\item{Совершается проход в цикле по всем пакетам. На каждом шаге цикла проверяется}
\end{enumerate}
\begin{itemize}
\item{Для каждого \textit{provide} пакета проверяется является ли он избыточным: существует ли
строка из списка \textit{requires\_conflicts} или находится ли он в одной из заданных директорий.
Если не является, то данный пакет помечается, как поврежденный, а данный provide помечается,
как избыточный, то есть вызывается метод \emph{add\_unmatched\_provide} у объекта класса \textit{IndexTestResult}}
\item{Для каждого \textit{require} пакета проверяется не является ли он анметом: существует ли
соответствующая строка из списка \textit{provides}. Если не существует, то пакет помечается, как 
поврежденный, а \textit{require}, как \textit{анмет}, то есть вызывается метод \textit{add\_unmatched\_require}
у объекта класса \textit{IndexTestResult}}
\item{Для каждого \textit{conflict} пакета проверяется не является ли он избыточным: существует ли
соответствующая строка из списка \textit{provides}. Если не существует, то пакет помечается, как 
поврежденный, а \textit{conflict}, как поврежденный, то есть вызывается метод \textit{add\_unmatched\_conflict}
у объекта класса \textit{IndexTestResult}}

\item{Возвращается объект класса \textit{IndexTestResult}}
\end{itemize}

\subsection{Утилита для проверки готового индекса}
Для тестирования целостности репозитория используются данные из файла \textit{rpms.data},
в котором описание каждого пакета соответствует следующему формату:
\begin{itemize}
\item{[name-version-release.architecture.rpm] }
\item{n=name} 
\item{e=epoch}
\item{v=version}
\item{r=release}
\item{arch=architecture}
\item{btime=build time}
\item{p:provide}
\item{r:require}
\item{c:conflict}
\item{o:obsolete}
\end{itemize}
Очевидно, что каждому пакету соответствует набор множеств \textit{provides},
\textit{requires}, \textit{conflicts}, \textit{obsoletes}, которые могут быть и пустыми.\\

Под целостностью репозитория понимается состояние, которое удовлетворяет следующим
условиям:
\begin{itemize}
\item{Для каждого \textit{require} пакета существует одноименный \textit{provide} 
другого пакета. Require, для которого это условие не выполняется
называется \textit{анметом (unmet)}. }
\item{Для каждого \textit{provide} существует одноименный \textit{require/conflict} или
он находится в директории из заранее заданного списка.Это условие 
контролирует появление избыточных \textit{provide}, засчет которых %%FIXME:сделать ссылку на место, где про это говорилось
может существенно расти размер индекса.}
\item{Для каждого \textit{conflict} пакета существует одноименный \textit{provide} 
другого пакета. Это условие не является таким строгим, как два предыдущих,
но желательно, чтобы оно выполнялось. }
\end{itemize}

В качестве входных данных используется файл с содержимым формата, описанного выше,
и расширением \textit{*.data.gz}.

Таким образом, первый этап проверки сводится к выполнению следующих действий:
\begin{itemize}
\item{Создание объектов класса \textit{IndexParser} и \textit{IndexTester}.}
\item{Создание и заполнение массива объектов класса \textit{Package} при помощи
вызова метода \textit{get\_packages\_from\_index\_files} у объекта класса \textit{IndexParser}.}
\item{Получение результатов тестирования посредством вызова метода \textit{test\_index}
у объекта класса \textit{IndexTester}}
\end{itemize}

На выходе получается статистика вида:\\
\\
Found [количество найденных пакетов] packages\\
.[количество поврежденных пакетов] packages are damaged\\
.[количество пакетов с избыточными provide] packages have unmatched provides\\
.[количество пакетов с анметами] packages have unmets\\
.[количество пакетов с избыточными conflict] packages have unmatched conflicts\\

Подробная информация о повреждениях регулируется с помощью ключей и имеет следующий формат:\\
package [имя пакета] has unmatched [тип: provide или conflict] [строка соответствующая повреждению]\\
package [имя пакета] has [тип: unmet] [строка соответствующая повреждению]\\

\subsection{Проверка утилит для обновления индекса}
Для данной проверки в качестве входных данных необходимо предоставить
путь до каталога \textit{base.*}, так как утилиты \textit{ds-patch} и 
\textit{ds-provides} используют данные всех файлов из директории.\\
Под утилитами для обновления индекса подразумеваются описанные
выше \textit{ds-patch} и \textit{ds-provides}.

Проверка представляет собой последовательность действий:\\
\begin{itemize}
\item{Проведение начального тестирования на неизменном индексе. Сохранение
и вывод результатов.}
\item{Совершаем проход в цикле по каждой директории из \emph{INDEX\_FILES\_PATH}. На
каждом шаге:
	\begin{itemize}
	\item{Формируем список пакетов для текущей директории.}
	\item{Для каждого пакета из списка вызывается утилита \textit{ds-patch }
	для текущего пакета, затем \textit{ds-provides} для директории файла, а 
	так же связанных с ней. После этого проводится тестирование
	измененного индекса и вывод результатов отличных от начальных
	с использование метода \textit{diff} объекта класса \textit{IndexTestResult}.}
	\end{itemize}
}
\end{itemize}

В качестве результата данная утилита предоставляет статистику выше описанного формата,
полученную сначала на готовом индексе, а затем после каждого запуска утилит для обновления
индекса. Отображение выходных данных этой утилиты так же регулируется ключами.








